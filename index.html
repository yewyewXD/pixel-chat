<!--

1) AUTHENTICATE WITH METAMASK
2) ADD USER TO DB
3) ADD MORE DATA TO THE USER PROFILE

-->

<html>
  <head>
    <title>Metamask Demo</title>

    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://npmcdn.com/moralis@0.0.6/dist/moralis.js"></script>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
  </head>

  <body>
    <button onclick="login()">Login with Metamask</button>
    <br /><br />

    <script>
      Moralis.initialize("UuODzE6wvQ33uBGpHNI9psoJLOpCF2EZD0yG2E6d"); // Application id from moralis.io
      Moralis.serverURL = "https://vrbdy1tqiytg.usemoralis.com:2053/server"; //Server url from moralis.io

      var state = {};
      var sprites = [];
      var buttonsLocked = {};
      let gameInitialized = false;

      const PLAYER_SIZE = 50;
      const MOVE_COOLOFF = 200;
      const MOVE_SPEED = 15;

      let lastMove = 0; // date

      let myPositionX = 0;
      let myPositionY = 0;
      let myRoomId = "";

      // server move request queue
      let currentQueueId = 0;

      async function login() {
        console.log("login clicked");
        var user = await Moralis.Web3.authenticate();
        if (user) {
          console.log(user);
          location.reload();
        }
      }

      console.log(Moralis.User.current());

      var config = {
        type: Phaser.AUTO,
        width: 1200,
        height: 700,
        scene: {
          preload: preload,
          create: create,
          update: update,
        },
        physics: {
          default: "arcade",
          arcade: { debug: true },
        },
      };

      var game = new Phaser.Game(config);
      var context;

      var users = [];

      function preload() {
        context = this;
      }

      async function create() {
        if (!Moralis.User.current()) return;

        this.wKey = this.input.keyboard.addKey(
          Phaser.Input.Keyboard.KeyCodes.W
        );
        this.aKey = this.input.keyboard.addKey(
          Phaser.Input.Keyboard.KeyCodes.A
        );
        this.sKey = this.input.keyboard.addKey(
          Phaser.Input.Keyboard.KeyCodes.S
        );
        this.dKey = this.input.keyboard.addKey(
          Phaser.Input.Keyboard.KeyCodes.D
        );

        const query = new Moralis.Query("Room1");
        const subscription = await query.subscribe();

        subscription.on("update", (room) => {
          const roomId = room.id;
          const newX = room.get("x");
          const newY = room.get("y");

          // if new player
          if (!users[roomId]) {
            // remember my position and id
            myPositionX = newX;
            myPositionY = newY;
            myRoomId = roomId;

            // create new player
            users[roomId] = this.add.rectangle(
              newX,
              newY,
              PLAYER_SIZE,
              PLAYER_SIZE,
              0x6666ff
            );
          } else if (
            (newX !== myPositionX || newY !== myPositionY) &&
            room.get("queueId") === currentQueueId
          ) {
            users[roomId].setPosition(newX, newY);
            myPositionX = newX;
            myPositionY = newY;
          }
        });

        await Moralis.Cloud.run("move", { direction: null }); //just to register the player

        let nearbyPlayers = await Moralis.Cloud.run("playersNearby");
        nearbyPlayers.forEach((player) => {
          users[player.id] = this.add.rectangle(
            player.get("x"),
            player.get("y"),
            PLAYER_SIZE,
            PLAYER_SIZE,
            0x6666ff
          );
        });

        gameInitialized = true;
      }

      async function update() {
        if (!gameInitialized) return;

        // dont move if cool off hasnt passed
        if (new Date() - lastMove < MOVE_COOLOFF) return;

        if (this.wKey.isDown) {
          if (!buttonsLocked["up"]) {
            console.log("W is pressed");

            myPositionY -= MOVE_SPEED;
            users[myRoomId].setPosition(myPositionX, myPositionY);
            lastMove = new Date();
            currentQueueId += 1;

            buttonsLocked["up"] = true;
            let moveResult = await Moralis.Cloud.run("move", {
              direction: "up",
              queueId: currentQueueId,
            });
            console.log(moveResult);
            buttonsLocked["up"] = false;
          }
        } else if (this.aKey.isDown) {
          if (!buttonsLocked["left"]) {
            console.log("A is pressed");

            myPositionX -= MOVE_SPEED;
            users[myRoomId].setPosition(myPositionX, myPositionY);
            lastMove = new Date();
            currentQueueId += 1;

            buttonsLocked["left"] = true;
            let moveResult = await Moralis.Cloud.run("move", {
              direction: "left",
              queueId: currentQueueId,
            });
            console.log(moveResult);
            buttonsLocked["left"] = false;
          }
        } else if (this.sKey.isDown) {
          if (!buttonsLocked["down"]) {
            console.log("S is pressed");

            myPositionY += MOVE_SPEED;
            users[myRoomId].setPosition(myPositionX, myPositionY);
            lastMove = new Date();
            currentQueueId += 1;

            buttonsLocked["down"] = true;
            let moveResult = await Moralis.Cloud.run("move", {
              direction: "down",
              queueId: currentQueueId,
            });
            console.log(moveResult);
            buttonsLocked["down"] = false;
          }
        } else if (this.dKey.isDown) {
          if (!buttonsLocked["right"]) {
            console.log("D is pressed");

            myPositionX += MOVE_SPEED;
            users[myRoomId].setPosition(myPositionX, myPositionY);
            lastMove = new Date();
            currentQueueId += 1;

            buttonsLocked["right"] = true;
            let moveResult = await Moralis.Cloud.run("move", {
              direction: "right",
              queueId: currentQueueId,
            });
            console.log(moveResult);
            buttonsLocked["right"] = false;
          }
        }
      }
    </script>
  </body>
</html>
